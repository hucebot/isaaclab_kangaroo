# Copyright (c) 2022-2025, The Isaac Lab Project Developers (https://github.com/isaac-sim/IsaacLab/blob/main/CONTRIBUTORS.md).
# Copyright (c) 2025, Fabio Amadio (fabioamadio93@gmail.com).
# All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause

"""Configuration for a kangaroo robot."""

import isaaclab.sim as sim_utils
from isaaclab.actuators import ImplicitActuatorCfg
from isaaclab.assets import ArticulationCfg
from isaaclab_kangaroo.assets import KANGAROO_ASSETS_DATA_DIR

##
# Configuration
##

init_pos_squat = (0.0, 0.0, 0.703)
init_joint_pos_squat = {
    "left_yaw_motor_joint": -1.3433574963528372e-07,
    "leg_left_1_joint": 0.00026511927717365324,
    "leg_right_1_joint": 0.00034714152570813894,
    "right_yaw_motor_joint": 1.8527547354096896e-06,
    "leg_left_1_motor": -1.168179096566746e-05,
    "left_hip_differential_2_cradle_joint": -1.2699663898274594e-07,
    "left_hip_differential_3_cradle_joint": 2.737188253831846e-07,
    "leg_left_2_joint": -5.321651315171039e-07,
    "leg_right_2_joint": 1.237313244928373e-05,
    "right_hip_differential_2_cradle_joint": -7.637705152774288e-07,
    "right_hip_differential_3_cradle_joint": -3.335990470532124e-07,
    "leg_right_1_motor": 1.6720321582397446e-05,
    "left_hip_differential_2_motor_joint": -4.886339411314111e-06,
    "left_hip_differential_3_motor_joint": 5.366953701013699e-06,
    "leg_left_3_joint": -0.00010146515705855563,
    "leg_right_3_joint": -0.00010840173490578309,
    "right_hip_differential_2_motor_joint": -6.353833668981679e-06,
    "right_hip_differential_3_motor_joint": 5.292111836752156e-06,
    "leg_left_2_motor": -4.25370899392874e-06,
    "leg_left_3_motor": 4.474564775591716e-06,
    "left_ankle_4_motor_joint": -2.0741239836752356e-07,
    "left_ankle_4_pendulum_joint": 2.583773550668411e-07,
    "left_ankle_5_motor_joint": 9.190638934342132e-07,
    "left_ankle_5_pendulum_joint": 1.2927373518323293e-06,
    "left_hip_differential_2_univ_joint": -9.829303598962724e-05,
    "left_hip_differential_3_univ_joint": -9.853051597019657e-05,
    "left_rear_short_bar_joint": 0.09191162139177322,
    "leg_left_femour_joint": -0.6151071190834045,
    "leg_right_femour_joint": -0.615109920501709,
    "right_ankle_4_motor_joint": -1.329659653492854e-06,
    "right_ankle_4_pendulum_joint": -9.725199561216868e-07,
    "right_ankle_5_motor_joint": -4.669570614623808e-07,
    "right_ankle_5_pendulum_joint": 1.5601164022882585e-06,
    "right_hip_differential_2_univ_joint": -0.00010662923159543425,
    "right_hip_differential_3_univ_joint": -0.00010814957204274833,
    "right_rear_short_bar_joint": 0.09191320091485977,
    "leg_right_2_motor": -6.778268470952753e-06,
    "leg_right_3_motor": 4.893884579360019e-06,
    "leg_left_4_motor": -5.164084715403305e-10,
    "left_4_higher_ankle_bar_joint": -0.6152138710021973,
    "leg_left_5_motor": -6.115354267421935e-08,
    "left_5_higher_ankle_bar_joint": -0.6152129769325256,
    "leg_left_knee_joint": 1.2381603717803955,
    "leg_left_length_motor": 0.07499990612268448,
    "leg_right_knee_joint": 1.2381635904312134,
    "leg_right_length_motor": 0.07500015199184418,
    "leg_right_4_motor": 4.4630958484503935e-08,
    "right_4_higher_ankle_bar_joint": -0.6152178645133972,
    "leg_right_5_motor": -6.411724484678416e-08,
    "right_5_higher_ankle_bar_joint": -0.6152155995368958,
    "left_femour_triangle_connection_joint": 1.238298773765564,
    "left_4_butterfly_joint": -0.62225341796875,
    "left_5_butterfly_joint": -0.6222547888755798,
    "leg_left_4_joint": 0.6222208738327026,
    "left_leg_length_short_bars_joint": 0.3177063465118408,
    "leg_right_4_joint": 0.622249960899353,
    "right_4_butterfly_joint": -0.6222530007362366,
    "right_5_butterfly_joint": -0.6222565770149231,
    "right_leg_length_short_bars_joint": 0.31770598888397217,
    "right_femour_triangle_connection_joint": 1.2383015155792236,
    "left_4_knee_ball_joint": -0.6222632527351379,
    "left_5_knee_ball_joint": -0.6222662925720215,
    "leg_left_5_joint": -4.267545136826811e-06,
    "leg_right_5_joint": -8.593281677349296e-07,
    "right_4_knee_ball_joint": -0.6222530007362366,
    "right_5_knee_ball_joint": -0.6222566962242126,
    "left_rear_long_bar_joint": -1.238326072692871,
    "left_4_lower_ankle_bar_joint": -2.998234549522749e-06,
    "left_5_lower_ankle_bar_joint": 3.1672404929850018e-06,
    "left_4_ankle_ball_joint": -3.105567216873169,
    "left_5_ankle_ball_joint": -2.9519901275634766,
    "right_4_ankle_ball_joint": -3.136420965194702,
    "right_5_ankle_ball_joint": -3.1341946125030518,
    "right_4_lower_ankle_bar_joint": -3.0431478990067262e-06,
    "right_5_lower_ankle_bar_joint": 3.05350204143906e-06,
    "right_rear_long_bar_joint": -1.2383291721343994,
}

init_pos_bent_knees = (0.0, 0.0, 0.830)
init_joint_pos_bent_knees = {
    "left_yaw_motor_joint": -3.4944818594340177e-07,
    "leg_left_1_joint": -0.000677300151437521,
    "leg_right_1_joint": 0.00025150220608338714,
    "right_yaw_motor_joint": 1.11476856545778e-06,
    "leg_left_1_motor": 2.5679448299342766e-05,
    "left_hip_differential_2_cradle_joint": 4.41919723925821e-07,
    "left_hip_differential_3_cradle_joint": 3.383187561212253e-07,
    "leg_left_2_joint": -6.897935236338526e-06,
    "leg_right_2_joint": 1.8220647689304315e-05,
    "right_hip_differential_2_cradle_joint": -3.8722788531231345e-07,
    "right_hip_differential_3_cradle_joint": -7.351515023401589e-07,
    "leg_right_1_motor": 1.0685524102882482e-05,
    "left_hip_differential_2_motor_joint": 2.7125988708576187e-05,
    "left_hip_differential_3_motor_joint": -2.5463936253800057e-05,
    "leg_left_3_joint": 0.0005193830584175885,
    "leg_right_3_joint": -0.00016278338443953544,
    "right_hip_differential_2_motor_joint": -9.436660548090003e-06,
    "right_hip_differential_3_motor_joint": 7.468739568139426e-06,
    "leg_left_2_motor": 1.666243770159781e-05,
    "leg_left_3_motor": -1.566867285873741e-05,
    "left_ankle_4_motor_joint": -3.262597942921275e-07,
    "left_ankle_4_pendulum_joint": -2.2222599227461615e-07,
    "left_ankle_5_motor_joint": -2.408954458132939e-07,
    "left_ankle_5_pendulum_joint": -6.8648291744466405e-06,
    "left_hip_differential_2_univ_joint": 0.000522645830642432,
    "left_hip_differential_3_univ_joint": 0.0005203991895541549,
    "left_rear_short_bar_joint": 0.09663055837154388,
    "leg_left_femour_joint": -0.3817138671875,
    "leg_right_femour_joint": -0.3771568536758423,
    "right_ankle_4_motor_joint": -3.629354239365057e-07,
    "right_ankle_4_pendulum_joint": -1.889777195174247e-06,
    "right_ankle_5_motor_joint": -1.8974765225721058e-07,
    "right_ankle_5_pendulum_joint": -1.428194309482933e-06,
    "right_hip_differential_2_univ_joint": -0.00016212202899623662,
    "right_hip_differential_3_univ_joint": -0.0001628792961128056,
    "right_rear_short_bar_joint": 0.09623796492815018,
    "leg_right_2_motor": -7.3756355050136335e-06,
    "leg_right_3_motor": 5.265532308840193e-06,
    "leg_left_4_motor": -8.463304723704823e-09,
    "left_4_higher_ankle_bar_joint": -0.38177135586738586,
    "leg_left_5_motor": 1.7358669879286026e-07,
    "left_5_higher_ankle_bar_joint": -0.38177764415740967,
    "leg_left_knee_joint": 0.7723039984703064,
    "leg_left_length_motor": 0.03813038393855095,
    "leg_right_knee_joint": 0.7631162405014038,
    "leg_right_length_motor": 0.037500057369470596,
    "leg_right_4_motor": 5.332879737807161e-08,
    "right_4_higher_ankle_bar_joint": -0.3772147297859192,
    "leg_right_5_motor": -3.7811190622960567e-08,
    "right_5_higher_ankle_bar_joint": -0.3772141635417938,
    "left_femour_triangle_connection_joint": 0.7724165320396423,
    "left_4_butterfly_joint": -0.3901430368423462,
    "left_5_butterfly_joint": -0.3901369869709015,
    "leg_left_4_joint": 0.3901137113571167,
    "left_leg_length_short_bars_joint": 0.25553447008132935,
    "leg_right_4_joint": 0.3855155408382416,
    "right_4_butterfly_joint": -0.38551831245422363,
    "right_5_butterfly_joint": -0.3855189085006714,
    "right_leg_length_short_bars_joint": 0.25346893072128296,
    "right_femour_triangle_connection_joint": 0.7632284164428711,
    "left_4_knee_ball_joint": -0.3901517987251282,
    "left_5_knee_ball_joint": -0.3901463449001312,
    "leg_left_5_joint": -1.9200824681320228e-05,
    "leg_right_5_joint": -7.00485998095246e-07,
    "right_4_knee_ball_joint": -0.38551828265190125,
    "right_5_knee_ball_joint": -0.3855190575122833,
    "left_rear_long_bar_joint": -0.7724400758743286,
    "left_4_lower_ankle_bar_joint": -1.8473568843546673e-06,
    "left_5_lower_ankle_bar_joint": 1.7603399555810029e-06,
    "left_4_ankle_ball_joint": -3.1031477451324463,
    "left_5_ankle_ball_joint": -2.415418863296509,
    "right_4_ankle_ball_joint": -1.521798014640808,
    "right_5_ankle_ball_joint": -1.5302060842514038,
    "right_4_lower_ankle_bar_joint": -1.8283642475580564e-06,
    "right_5_lower_ankle_bar_joint": 1.6477137023684918e-06,
    "right_rear_long_bar_joint": -0.7632517218589783,
}


KANGAROO_CFG = ArticulationCfg(
    spawn=sim_utils.UsdFileCfg(
        usd_path=f"{KANGAROO_ASSETS_DATA_DIR}/kangaroo.usd",
        activate_contact_sensors=True,
        rigid_props=sim_utils.RigidBodyPropertiesCfg(
            disable_gravity=False,
            retain_accelerations=False,
            linear_damping=0.0,
            angular_damping=0.0,
            max_linear_velocity=1000.0,
            max_angular_velocity=1000.0,
            max_depenetration_velocity=1.0,
        ),
        articulation_props=sim_utils.ArticulationRootPropertiesCfg(
            enabled_self_collisions=False,
            solver_position_iteration_count=8,
            solver_velocity_iteration_count=4,
        ),
    ),
    init_state=ArticulationCfg.InitialStateCfg(
        pos=init_pos_bent_knees,
        joint_pos=init_joint_pos_bent_knees,
        joint_vel={".*": 0.0},
    ),
    soft_joint_pos_limit_factor=1.0,
    actuators={
        "motor": ImplicitActuatorCfg(
            joint_names_expr=[
                "leg_left_1_motor",
                "leg_right_1_motor",
                "leg_left_2_motor",
                "leg_left_3_motor",
                "leg_right_2_motor",
                "leg_right_3_motor",
                "leg_left_4_motor",
                "leg_left_5_motor",
                "leg_left_length_motor",
                "leg_right_length_motor",
                "leg_right_4_motor",
                "leg_right_5_motor",
            ],
            effort_limit={
                "leg_left_1_motor": 3000,
                "leg_right_1_motor": 3000,
                "leg_left_2_motor": 3000,
                "leg_right_2_motor": 3000,
                "leg_left_3_motor": 3000,
                "leg_right_3_motor": 3000,
                "leg_left_4_motor": 3000,
                "leg_right_4_motor": 3000,
                "leg_left_5_motor": 3000,
                "leg_right_5_motor": 3000,
                "leg_left_length_motor": 5000,
                "leg_right_length_motor": 5000,
            },
            velocity_limit={
                "leg_left_1_motor": 0.4,
                "leg_right_1_motor": 0.4,
                "leg_left_2_motor": 0.4,
                "leg_right_2_motor": 0.4,
                "leg_left_3_motor": 0.4,
                "leg_right_3_motor": 0.4,
                "leg_left_4_motor": 0.4,
                "leg_right_4_motor": 0.4,
                "leg_left_5_motor": 0.4,
                "leg_right_5_motor": 0.4,
                "leg_left_length_motor": 0.625,
                "leg_right_length_motor": 0.625,
            },
            stiffness={
                "leg_left_1_motor": 300000.0,
                "leg_right_1_motor": 300000.0,
                "leg_left_2_motor": 700000.0,
                "leg_right_2_motor": 700000.0,
                "leg_left_3_motor": 700000.0,
                "leg_right_3_motor": 700000.0,
                "leg_left_4_motor": 800000.0,
                "leg_right_4_motor": 800000.0,
                "leg_left_5_motor": 800000.0,
                "leg_right_5_motor": 800000.0,
                "leg_left_length_motor": 1000000.0,
                "leg_right_length_motor": 1000000.0,
            },
            damping={
                "leg_left_1_motor": 1095.0,
                "leg_right_1_motor": 1095.0,
                "leg_left_2_motor": 1673.0,
                "leg_right_2_motor": 1673.0,
                "leg_left_3_motor": 1673.0,
                "leg_right_3_motor": 1673.0,
                "leg_left_4_motor": 1789.0,
                "leg_right_4_motor": 1789.0,
                "leg_left_5_motor": 1789.0,
                "leg_right_5_motor": 1789.0,
                "leg_left_length_motor": 2000.0,
                "leg_right_length_motor": 2000.0,
            },
            armature={
                "leg_left_1_motor": 0.01,
                "leg_right_1_motor": 0.01,
                "leg_left_2_motor": 0.01,
                "leg_right_2_motor": 0.01,
                "leg_left_3_motor": 0.01,
                "leg_right_3_motor": 0.01,
                "leg_left_4_motor": 0.01,
                "leg_right_4_motor": 0.01,
                "leg_left_5_motor": 0.01,
                "leg_right_5_motor": 0.01,
                "leg_left_length_motor": 0.01,
                "leg_right_length_motor": 0.01,
            },
        ),
    },
)
"""Configuration for the PAL Kangaroo robot."""


KANGAROO_MINIMAL_CFG = KANGAROO_CFG.copy()
KANGAROO_MINIMAL_CFG.spawn.usd_path = f"{KANGAROO_ASSETS_DATA_DIR}/kangaroo_simplified_collision.usd"
KANGAROO_MINIMAL_CFG.spawn.articulation_props = sim_utils.ArticulationRootPropertiesCfg(
    enabled_self_collisions=True,
    solver_position_iteration_count=8,
    solver_velocity_iteration_count=4,
)
"""Configuration for the PAL Kangaroo robot with simplified collision meshes."""


KANGAROO_FIXED_CFG = KANGAROO_MINIMAL_CFG.copy()
KANGAROO_FIXED_CFG.spawn.articulation_props = sim_utils.ArticulationRootPropertiesCfg(
    enabled_self_collisions=False,
    fix_root_link=True,
)
KANGAROO_FIXED_CFG.init_state = ArticulationCfg.InitialStateCfg(
    pos=(0.0, 0.0, 1.0),
    joint_pos=init_joint_pos_bent_knees,
    joint_vel={".*": 0.0},
)
"""Configuration for the PAL Kangaroo with fixed root link."""
